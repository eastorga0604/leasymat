<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="sale_order_portal_content_inherit_custom"
            inherit_id="sale.sale_order_portal_content">

    <!-- 1) (Keep) your CSS tweak -->
    <xpath expr="//section[@id='details']" position="before">
      <style>
        /* optional from your file */
        table#sales_order_table td.text-end span:nth-of-type(2) { display: none !important; }

        /* 2) Hide TAXES column robustly via IDs (no XPath replace) */
        /* These IDs exist on standard portal rows; if your theme renamed them,
           replace with your actual ids/classes (view raw HTML to confirm). */
        #sales_order_table th#taxes_header,
        #sales_order_table td#taxes {
          display: none !important;
        }
      </style>
    </xpath>

    <!-- 3) Replace the *body* unit price with monthly (tolerant selector) -->
    <xpath expr="//*[@t-field='line.price_unit' or @t-esc='line.price_unit']"
           position="replace">
      <span t-field="line.effective_price_quote"
            t-options='{"widget": "monetary", "display_currency": sale_order.currency_id}'/>
    </xpath>

    <!-- 4) Rename the header to “Devis mensuel” via a tiny JS (no brittle xpath) -->
    <xpath expr="//table[@id='sales_order_table']" position="after">
      <script type="text/javascript"><![CDATA[
        document.addEventListener('DOMContentLoaded', function () {
          var table = document.getElementById('sales_order_table');
          if (!table) return;
          var heads = table.querySelectorAll('thead th.text-end');
          if (heads && heads[1]) {
            heads[1].textContent = 'Devis mensuel';
          }
        });
      ]]></script>
    </xpath>

    <!-- 5) Totals block (your lines) -->
    <xpath expr="//div[@id='total']//div[contains(@class,'ms-auto')]" position="inside">
      <div class="d-flex justify-content-between mb-1">
        <span t-translate="yes">IVA (20%):</span>
        <span t-field="sale_order.amount_vat_20"/>
      </div>
      <div class="d-flex justify-content-between">
        <strong t-translate="yes">Total Incl. IVA:</strong>
        <strong t-field="sale_order.amount_total_incl_vat_20"/>
      </div>
    </xpath>

  </template>
</odoo>